@using Microsoft.AspNetCore.Http
@model prjiSpanFinal.ViewModels.Item.CItemIndexViewModel
@{
    ViewData["Title"] = "Index";
    int memberID = 0;
    if (Model.user != null)
    {
        memberID = Model.user.MemberId;
    }
    string bigTypeUrl = Url.Content("~/Category/Index") + $"?id={Model.bigType.BigTypeId}";
}
@section Styles{
    <link rel="stylesheet" href="@Url.Content("~/css/Item/ItemIndex.css")" />
    <link href="@Url.Content("~/css/ProductCard.css")" rel="stylesheet" />
    <link href="@Url.Content("~/css/Item/ShowItemComment.css")" rel="stylesheet" />
}
<div class="memberID d-none">@memberID</div>
<div class="sellerID d-none">@Model.seller.MemberId</div>
<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Content("~/Home/Index")">蝦到爆</a></li>
        <li class="breadcrumb-item"><a href="@bigTypeUrl">@Model.bigType.BigTypeName</a></li>
        <li class="breadcrumb-item active" aria-current="page">@Model.smallType.SmallTypeName</li>
    </ol>
</nav>
<div class="d-flex justify-content-between">
    <div class="productPhoto">
        <div class="bigPhoto position-relative">
            <div class="addItemLike">加入按讚好物</div>
            @{
                if (Model.Islike)
                {
                    <i class="itemHeart fa-solid fa-heart position-absolute top-0 end-0 fs-2 opacity-50 text-danger"></i>
                }
                else
                {
                    <i class="itemHeart fa-solid fa-heart position-absolute top-0 end-0 fs-2 opacity-50"></i>
                }
                string imgSrc1 = "";
                try
                {
                    string base64 = Convert.ToBase64String(Model.productPics[0]);
                    imgSrc1 = $"data:image/gif;base64,{base64}";
                }
                catch
                {
                    imgSrc1 = Url.Content("~/img/imageNotFound.png");
                }
                <img src="@imgSrc1" />
            }
        </div>
        <div class="smallPhoto d-flex justify-content-center">
            @foreach (var i in Model.productPics)
            {
                string imgSrc2 = "";
                try
                {
                    string base65 = Convert.ToBase64String(i);
                    imgSrc2 = $"data:image/gif;base64,{base65}";
                }
                catch
                {
                    imgSrc2 = Url.Content("~/img/imageNotFound.png");
                }
                <div><img src="@imgSrc2" /></div>
            }
        </div>
        <div style="font-size:14px">
            <div class="d-flex justify-content-between border-top border-bottom py-2">
                <div>商品編號:<span class="ms-2">@Model.product.ProductId</span></div>
                @{
                    if (Model.user == null)
                    {
                        <label class="text-primary">登入後方可使用檢舉功能</label>
                    }
                    else
                    {
                        <a id="ReportBTN" href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#reportmodal">檢舉</a>
                    }
                }
            </div>
            <div>
                <div class="fs-6 fw-bold">商品備註</div>
                <ul>
                    <li>物品所在地:台灣，<span>@Model.sellerRegion</span></li>
                    <li>物品最新更新時間:<span>@Model.product.EditTime.ToString("yyyy-MM-dd")</span></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="itemInfo">
        <h4>@Model.product.ProductName</h4>
        <div class="d-flex justify-content-start align-items-center">
            @{
                if (Model.commentCount == 0)
                {
                    <div class="opacity-50">尚無評價</div>
                }
                else
                {
                    int starCount = Convert.ToInt32(Math.Round(Model.avgCommentStar, MidpointRounding.AwayFromZero));
                    for (int i = 1; i <= 5; i++)
                    {
                        if (i <= starCount)
                        {
                            <i class="text-warning fa-solid fa-star"></i>
                        }
                        else
                        {
                            <i class="fa-regular fa-star"></i>
                        }
                    }
                    <div class="ms-3">
                        @Model.avgCommentStar
                    </div>
                }
                <div class="ms-1">

                    <span>(</span><a href="#">@Model.commentCount</a><span>)</span>
                </div>
                <div class="ms-3">|</div>
                <div class="ms-3">已售出:<span>@Model.salesVolume</span></div>
            }
        </div>
        <div class="itemDetails mb-2">
            <form method="post" action="/Delivery/Checkout">
                <div class="d-flex justify-content-start align-items-center mb-1">
                    <div class="itemKey">直購價:</div>
                    @{
                        string price = "";
                        List<decimal> prices = new List<decimal>();
                        foreach (var p in Model.productDetails)
                        {
                            prices.Add(p.UnitPrice);
                        }
                        decimal maxPrice = prices.Max();
                        decimal minPrice = prices.Min();
                        if (minPrice == maxPrice)
                        {
                            price = "$" + minPrice.ToString("0");
                        }
                        else
                        {
                            price = $"${minPrice.ToString("0")} - ${maxPrice.ToString("0")}";
                        }
                        <div class="itemPrice ms-3 fs-3 fw-bold text-danger">@price</div>
                    }
                </div>
                <div class="d-flex justify-content-between align-self-start mb-1">
                    <input type="hidden" name="purchaseProduct" value="2113" />
                    @{
                        if (Model.productDetails.Count > 1)
                        {
                            <div class="itemKey">規格:</div>
                        }
                    }

                    <div class="itemStyleContent d-flex flex-wrap ms-3">
                        @{
                            foreach (var i in Model.productDetails)
                            {
                                string imgSrc2 = "";
                                try
                                {
                                    string base65 = Convert.ToBase64String(i.Pic);
                                    imgSrc2 = $"data:imgae/gif;base64,{base65}";
                                }
                                catch
                                {
                                    imgSrc2 = Url.Content("~/img/imageNotFound.png");
                                }
                                string style = i.Style;
                                int productDetailID = i.ProductDetailId;
                                string labelId = "style" + productDetailID;
                                string unitPrice = i.UnitPrice.ToString("0");
                                int quantity = i.Quantity;
                                <div class="ms-1 mb-1">
                                    @{
                                        if (i.Style == "樣式一")
                                        {
                                            <input type="radio" class="btn-check d-none" name="purchaseStyle" id="@labelId" autocomplete="off" value="@productDetailID" checked>
                                            <label class="purchaseStyle btn btn-outline-secondary btn-sm rounded-1 d-none" for="@labelId">@style</label>
                                        }
                                        else
                                        {
                                            <input type="radio" class="btn-check" name="purchaseStyle" id="@labelId" autocomplete="off" value="@productDetailID">
                                            <label class="purchaseStyle btn btn-outline-secondary btn-sm rounded-1" for="@labelId">@style</label>
                                        }
                                    }
                                    <div class="d-none price">@unitPrice</div>
                                    <img class="d-none itemStyleImg" src="@imgSrc2" />
                                </div>
                            }
                        }
                    </div>
                </div>
                <div class="d-flex justify-content-start align-items-center mb-3">
                    <label for="itemCount" class="itemKey">數量:</label>
                    <input type="number" value="1" name="purchaseCount" min="1" class="ms-3" id="itemCount" />
                    @{
                        if (Model.productDetails.Count > 1)
                        {
                            <div class="ms-3">還剩<span class="itemRemainingQty"></span>件數</div>
                        }
                        else
                        {
                            if (Model.user == null)
                            {
                                <div class="ms-3">還剩<span class="itemRemainingQty">@Model.productDetails[0].Quantity</span>件數</div>
                            }
                            else
                            {
                                <div class="ms-3">還剩<span class="itemRemainingQty">@Model.remainingQty</span>件數</div>
                            }
                        }
                    }

                </div>
                <div class="position-relative d-flex justify-content-start align-items-center ps-5">
                    <div class="dollarIcon position-absolute fs-3 fw-bold text-warning">+<span></span></div>
                    <input type="button" value="加入購物車" class="addToCart btn btn-warning me-3 ms-4" />
                    <input type="button" value="直接購買" class="buyDirectly btn btn-success" />
                </div>
            </form>
        </div>

        @{
            if (Model.sellerCoupons.Count > 0)
            {
                <div class="sellerCouponLayout position-relative mb-2" style="width:745px;height:120px;overflow:hidden">
                    <div class="sellerCouponCount d-none">@Model.sellerCoupons.Count</div>
                    <button class="couponLeft btn btn-light position-absolute bg-transparent border-0 p-0" style="left:0px;height:120px;font-size:8px"><i class="fa-solid fa-chevron-left"></i></button>
                    @{
                        if (Model.user != null)
                        {
                            foreach (var i in Model.sellerCoupons)
                            {
                                var hasCoupon = Model.userCouponWallet.Where(a => a.CouponId == i.CouponId).ToList();
                                if (hasCoupon.Count > 0)
                                {
                                    <div class="sellerCoupon border d-flex justify-content-between position-absolute opacity-50" style="font-size:14px;width:350px;height:120px;margin-right:10px">
                                        <div class="d-flex flex-column justify-content-around align-items-baseline ps-2">
                                            <div>@i.CouponName</div>
                                            @{
                                                if (i.IsFreeDelivery)
                                                {
                                                    if (i.MinimumOrder > 0)
                                                    {
                                                        <div>滿$<span>@i.MinimumOrder</span>即享免運費</div>
                                                    }
                                                    else
                                                    {
                                                        <div>不限金額皆享免運費</div>
                                                    }
                                                }
                                                else
                                                {
                                                    string discount = (i.Discount * 10).ToString("0.0");
                                                    if (discount.Split('.')[1] == "0")
                                                    {
                                                        discount = discount.Split('.')[0];
                                                    }
                                                    if (i.MinimumOrder > 0)
                                                    {

                                                        <div>滿$<span>@i.MinimumOrder</span>即享<span>@discount</span>折優惠</div>
                                                    }
                                                    else
                                                    {
                                                        <div>不限金額皆享<span>@discount</span>折優惠</div>
                                                    }
                                                }
                                            }
                                            <div>折扣碼:<span>@i.CouponCode</span></div>
                                            @{
                                                string period = i.StartDate.ToString("yyyy/MM/dd") + " ~ " + i.ExpiredDate.ToString("yyyy/MM/dd");
                                            }

                                            <div>活動期間:<span>@period</span></div>
                                            @{
                                                if (i.ExpiredDate != i.ReceiveEndDate)
                                                {
                                                    <div>最後領券時間:<span>@i.ReceiveEndDate.ToString("yyyy/MM/dd")</span></div>
                                                }
                                            }
                                        </div>
                                        <button class="getCoupon btn btn-warning rounded-0 fw-bold" id="@i.CouponId" type="button" disabled>領取</button>
                                    </div>
                                }
                                else
                                {
                                    <div class="sellerCoupon border d-flex justify-content-between position-absolute" style="font-size:14px;width:350px;height:120px;margin-right:10px">
                                        <div class="d-flex flex-column justify-content-around align-items-baseline ps-2">
                                            <div>@i.CouponName</div>
                                            @{
                                                if (i.IsFreeDelivery)
                                                {
                                                    if (i.MinimumOrder > 0)
                                                    {
                                                        <div>滿$<span>@i.MinimumOrder</span>免運費</div>
                                                    }
                                                    else
                                                    {
                                                        <div>不限金額都免運費</div>
                                                    }
                                                }
                                                else
                                                {
                                                    string discount = (i.Discount * 10).ToString("0.0");
                                                    if (discount.Split('.')[1] == "0")
                                                    {
                                                        discount = discount.Split('.')[0];
                                                    }
                                                    if (i.MinimumOrder > 0)
                                                    {

                                                        <div>滿$<span>@i.MinimumOrder</span>打<span>@discount</span>折</div>
                                                    }
                                                    else
                                                    {
                                                        <div>不限金額皆享<span>@discount</span>折優惠</div>
                                                    }
                                                }
                                            }
                                            <div>折扣碼:<span>@i.CouponCode</span></div>
                                            @{
                                                string period = i.StartDate.ToString("yyyy/MM/dd") + " ~ " + i.ExpiredDate.ToString("yyyy/MM/dd");
                                            }

                                            <div>活動期間:<span>@period</span></div>
                                            @{
                                                if (i.ExpiredDate != i.ReceiveEndDate)
                                                {
                                                    <div>最後領券時間:<span>@i.ReceiveEndDate.ToString("yyyy/MM/dd")</span></div>
                                                }
                                            }
                                        </div>
                                        <button class="getCoupon btn btn-warning rounded-0 fw-bold" id="@i.CouponId" type="button">領取</button>
                                    </div>
                                }
                            }

                        }
                        else
                        {
                            foreach (var i in Model.sellerCoupons)
                            {
                                <div class="sellerCoupon border d-flex justify-content-between position-absolute" style="font-size:14px;width:350px;height:120px;margin-right:10px">
                                    <div class="d-flex flex-column justify-content-around align-items-baseline ps-2">
                                        <div>@i.CouponName</div>
                                        @{
                                            if (i.IsFreeDelivery)
                                            {
                                                if (i.MinimumOrder > 0)
                                                {
                                                    <div>滿$<span>@i.MinimumOrder</span>免運費</div>
                                                }
                                                else
                                                {
                                                    <div>不限金額都免運費</div>
                                                }
                                            }
                                            else
                                            {
                                                string discount = (i.Discount * 10).ToString("0.0");
                                                if (discount.Split('.')[1] == "0")
                                                {
                                                    discount = discount.Split('.')[0];
                                                }
                                                if (i.MinimumOrder > 0)
                                                {

                                                    <div>滿$<span>@i.MinimumOrder</span>打<span>@discount</span>折</div>
                                                }
                                                else
                                                {
                                                    <div>不限金額皆享<span>@discount</span>折優惠</div>
                                                }
                                            }
                                        }
                                        <div>折扣碼:<span>@i.CouponCode</span></div>
                                        @{
                                            string period = i.StartDate.ToString("yyyy/MM/dd") + " ~ " + i.ExpiredDate.ToString("yyyy/MM/dd");
                                        }

                                        <div>活動期間:<span>@period</span></div>
                                        @{
                                            if (i.ExpiredDate != i.ReceiveEndDate)
                                            {
                                                <div>最後領券時間:<span>@i.ReceiveEndDate.ToString("yyyy/MM/dd")</span></div>
                                            }
                                        }
                                    </div>
                                    <button class="getCoupon btn btn-warning rounded-0 fw-bold" id="@i.CouponId" type="button">領取</button>
                                </div>
                            }
                        }
                    }
                    <button class="couponRight btn btn-light position-absolute bg-transparent border-0 p-0" style="right:0px;height:120px;font-size:8px"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
            }
        }
        <div class="row">
            <div class="col-8" style="font-size:14px">
                <div class="d-flex justify-content-start">
                    <div class="me-5">付款方式:</div>
                    <div>
                        @{
                            foreach (var i in Model.sellerPayment)
                            {
                                <div>@i.payment<span class="mx-2 text-danger" style="font-size:12px"><span>手續費:</span>@i.fee</span></div>
                            }
                        }
                    </div>
                </div>
                <div class="d-flex justify-content-start">
                    <div class="me-5">運送方式:</div>
                    <div>
                        @{
                            foreach (var i in Model.sellerShipper)
                            {
                                <div>@i.shipper<span class="mx-2 text-danger" style="font-size:12px">$<span>@i.fee</span></span></div>
                            }
                        }
                    </div>
                </div>
            </div>
            <div class="col-4" style="font-size:14px">
                <div class="bg-secondary text-white fw-bold ps-2">賣家資訊</div>
                @{
                    string imgSrc = "";
                    if (Model.seller.MemPic != null)
                    {
                        string base64 = Convert.ToBase64String(Model.seller.MemPic);
                        imgSrc = $"data:image/gif;base64,{base64}";
                    }
                    else
                    {
                        imgSrc = Url.Content("~/img/Member/nopicmem.jpg");
                    }

                }
                <div class="d-flex align-items-center">
                    <div style="width:20px;aspect-ratio:1/1">
                        <img src="@imgSrc" style="width:100%;aspect-ratio:1/1;object-fit:contain;border-radius:50%" />
                    </div>
                    <div class="ps-2 fs-6">@Model.seller.MemberAcc<span class="ms-3"><a href="#"><i class="talkToSeller fa-solid fa-comment-dots text-warning"></i></a></span></div>
                </div>
                <div class="d-flex align-items-center ps-2">
                    <div>全部商品:</div>
                    <div class="ms-3"><a href="@Url.Content("~/SalesCourt/賣場?id="+Model.seller.MemberId)" class="fs-5 fw-bold text-primary ">@Model.sellerProductIDs.Count</a></div>
                </div>
                <div class="d-flex align-items-center ps-2">
                    <div>賣場評價:</div>
                    <div class="ms-3">
                        @{
                            if (Model.sellerCommentCount > 0)
                            {
                                string sellerComment = Model.avgSellerCommentStar.ToString("0.0") + "  " + "(" + Model.sellerCommentCount + ")";
                                <a href="@Url.Content("~/SalesCourt/評價?id="+Model.seller.MemberId)" class="fs-5 fw-bold text-primary ">@sellerComment</a>
                            }
                            else
                            {
                                <a href="@Url.Content("~/SalesCourt/評價?id="+Model.seller.MemberId)" class="opacity-50 text-primary" style="font-size:14px">尚無賣場評價</a>
                            }
                        }
                    </div>
                </div>
                <div class="ps-2"><a href="@Url.Content("~/SalesCourt/關於我?id="+Model.seller.MemberId)" class="text-primary">關於我</a></div>
                <div class="ps-2"><a href="@Url.Content("~/SalesCourt/賣場?id="+Model.seller.MemberId)" class="text-primary">追蹤賣家</a></div>
            </div>
        </div>
    </div>
</div>
<div class="sellerProducts my-3">
    <div class="fs-4 fw-bold text-primary">賣家精選</div>
    @await Component.InvokeAsync("ShowSelectedProducts", new { productIDs = Model.sellerProductIDs })
</div>

<div>
    <div class="list-group list-group-horizontal mb-3">
        <button type="button" class="list-group-item-warning list-group-item list-group-item-action active" id="description" aria-current="true">商品說明</button>
        <button type="button" class="list-group-item-warning list-group-item list-group-item-action" id="comment">商品評價 (<span>@Model.avgCommentStar.ToString("0.0")</span>/5)</button>
        <button type="button" class="list-group-item-warning list-group-item list-group-item-action" id="buyerCount">購買人次 (<span>@Model.buyerCount</span>)</button>
        <button type="button" class="list-group-item-warning list-group-item list-group-item-action" id="messageBoard">留言板</button>
    </div>
    <div class="itemDescription rounded-2">
        <div class="sellerName bg-warning bg-opacity-50 fs-3 fw-bold ps-2" id="@Model.seller.MemberAcc">@Model.seller.MemberAcc<span>的商店</span></div>
        <div class="w-100 bg-warning bg-opacity-10 pb-3">
            <div class="description">
                @Model.product.Description
            </div>
            @{
                foreach (var i in Model.productPics)
                {
                    string imgSrc3 = "";
                    try
                    {
                        string base64 = Convert.ToBase64String(i);
                        imgSrc3 = $"data:image/gif;base64,{base64}";
                    }
                    catch
                    {
                        imgSrc3 = Url.Content("~/img/imageNotFound.png");
                    }
                    <div class="productImg"><img src="@imgSrc3" /></div>
                }
            }
        </div>
    </div>
    <div class="commentVC d-none">
        @await Component.InvokeAsync("CShowItemComment", new { productID = Model.product.ProductId, page = 1 })
    </div>
    <div class="buyerCountVC d-none">
        @await Component.InvokeAsync("ShowBuyerCount", new { productID = Model.product.ProductId, page = 1 })
    </div>
    <div class="messageBoardVC d-none">
        @*@await Component.InvokeAsync("ShowMessageBoard", new { productID = Model.product.ProductId })*@
    </div>
</div>

<!--Modal-->

<div class="modal fade" id="reportmodal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="top: 7rem !important;">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">檢舉視窗</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div>
                    <label>產品名稱</label>
                    <input class="form-control" placeholder="@Model.product.ProductName" readonly>
                    <input id="ProductId" type="hidden" value="@Model.product.ProductId">
                    @{
                        if (Model.user == null)
                        {
                            Model.user = new MemberAccount();
                            Model.user.MemberId = 1;
                        }
                    }
                    <input id="ReporterID" type="hidden" value="@Model.user.MemberId">
                    <label>檢舉理由</label>
                    <select id="ReportTypeId" class="form-select ReportTypeId" name="ReportTypeId">
                        @{
                            foreach (var i in Model.ReportType)
                            {
                                <option value="@i.ReportTypeId">@i.ReportTypeName</option>
                            }
                        }
                    </select>
                    <label>檢舉理由</label>
                    <textarea id="Reason" class="form-control"></textarea>
                    <div class="form-group">
                        圖片<input type="file" id="ReportPic" class="form-control-file">
                    </div>
                    <p> 圖片預覽</p>
                    <img id="Preview" style="max-height:200px;" />
                </div>
            </div>
            <div class="modal-footer">
                <button id="save" type="button" class="btn btn-warning">新增</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

<!--Modal End-->
@section Scripts{
    <script src="@Url.Content("~/js/Item/ItemIndex.js")"></script>
    <script src="@Url.Content("~/js/ShowSelectedProducts.js")"></script>
    <script src="@Url.Content("~/js/Item/ShowItemComment.js")"></script>
    @*<script src="@Url.Content("~/js/Item/ShowMessageBoard.js")"></script>*@
    <script>
        let couponPosition = 15;
        let couponCount = Number($(".sellerCouponCount").html());
        let couponPageClickCount = 2;
        $(function () {
            const productID = $("#ProductId").val();
            $(".messageBoardVC").load("@Url.Content("~/Item/ShowMessageBoard")" + `?productID=${productID}`);
            userIsSeller();
            $(".sellerCoupon").each(function () {
                $(this).css("left", couponPosition);
                couponPosition += 365;
            });
            couponPageSelect();
        });

        function userIsSeller() {
            const userID = $(".memberID").html();
            const sellerID = $(".sellerID").html();
            if (userID == sellerID) {
                $(".addToCart").prop("disabled", true);
                $(".buyDirectly").prop("disabled", true);
                $(".sellerCoupon").addClass("opacity-50");
                $(".getCoupon").prop("disabled", true);
            }
        }

        $(".couponRight").click(function () {
            $(".sellerCoupon").animate({ left: "-=365px"});
            couponPageClickCount += 1;
            couponPageSelect();
        });
        $(".couponLeft").click(function () {
            $(".sellerCoupon").animate({ left: "+=365px" });
            couponPageClickCount -= 1;
            couponPageSelect();
        });
        function couponPageSelect() {
            if (couponPageClickCount <= 2) {
                $(".couponLeft").prop("disabled", true);
            }
            if (couponPageClickCount > 2) {
                $(".couponLeft").prop("disabled", false);
            }
            if (couponPageClickCount >= couponCount) {
                $(".couponRight").prop("disabled", true);
            }
            if (couponPageClickCount < couponCount) {
                $(".couponRight").prop("disabled", false);
            }
        }

        $(".bigPhoto .itemHeart").click(async function () {
            const memberID = Number($(".memberID").html());
            let requestUrl = "@Url.Content("~/Item/AddItemLike")" + `?memberID=${memberID}&productID=${@Model.product.ProductId}`;
            let response = await fetch(requestUrl);
            let data = await response.text();
            if (data == "0") {
                Swal.fire("請先登入方可加入我的最愛");
                return;
            }
            else if (data == "1") {
                $(this).removeClass("text-danger").addClass("text-danger");
            }
            else {
                $(this).removeClass("text-danger");
            }
            console.log(data);
        })
        $(".getCoupon").click(async function () {
            const couponID = Number($(this).attr("id"));
            const response = await fetch("@Url.Content("~/Item/GetCoupon")" + `?id=${couponID}`);
            const data = await response.text();
            if (data == "1") {
                Swal.fire("領取優惠券成功");
                $(this).closest(".sellerCoupon").addClass("opacity-50");
                $(this).prop("disabled", true);
            }
            else if (data == "0") {
                Swal.fire({
                    title: "請先登入再領取優惠券",
                    showDenyButton: false,
                    showCancelButton: true,
                    confirmButtonText: "登入",
                }).then((result) => {
                    if (result.isConfirmed) {
                        location.href = "@Url.Content("~/Member/Login")";
                    }
                })
            }
            else {
                Swal.fire("你已經領過此優惠券了");
            }
        });


        $(".buyDirectly").click(function () {
            const maxQuantity = Number($("input[name='purchaseCount']").attr("max"));
            if ($("input[name='purchaseStyle']:checked").length != 1) {
                Swal.fire("請選擇一個規格");
                return false;
            }
            else if (Number($("input[name='purchaseCount']").val()) <= 0 || Number($("input[name='purchaseCount']").val()) > maxQuantity) {
                Swal.fire("你選的數量有誤");
                return false;
            }
            else {
                const productDetailID = $("input:checked").val();
                const purchaseCount = $("#itemCount").val();
                window.location.href = "@Url.Content("~/Delivery/Checkout")" + `?productDetailID=${productDetailID}&purchaseCount=${purchaseCount}`;
            }
        });

        $(".addToCart").click(async function () {
            const memberID = @memberID;
            const maxQuantity = Number($("input[name='purchaseCount']").attr("max"));
            if (memberID <= 1) {
                Swal.fire("請先登入再加入購物車");
                return false;
            }
            else if ($("input[name='purchaseStyle']:checked").length != 1) {
                Swal.fire("請選擇一個規格");
                return false;
            }
            else if (Number($("input[name='purchaseCount']").val()) <= 0 || Number($("input[name='purchaseCount']").val()) > maxQuantity) {
                Swal.fire("你選的數量有誤");
                return false;
            }
            else {
                const productDetailID = $("input:checked").val();
                const quantity = $("#itemCount").val();
                const requestUrl = "@Url.Content("~/Delivery/AddItemToCart")" + `?productDetailID=${productDetailID}&quantity=${quantity}`;
                const response = await fetch(requestUrl);
                const data = await response.json();
                if (data != "0") {
                    $(".dollarIcon").children().html(quantity);
                    $(".dollarIcon").animate({
                        top: "-=50",
                        opacity: "1",
                        zIndex: "0"
                    }, 50).animate({
                        top: "-=30",
                        opacity: "0",
                    }, 500).animate({
                        top: "+=80",
                        zIndex: "-1"
                    });
                    $(".itemRemainingQty").html(data[1]);
                    $("input[name='purchaseCount']").attr("max", Number(data[1]))
                    if ($("input[name='purchaseCount']").val() > Number(data[1])) {
                        $("input[name='purchaseCount']").val(Number(data[1]));
                    }
                    if (Number(data[1]) <= 0) {
                        $("input:checked").attr("disabled", true);
                        $("input[name='purchaseCount']").val(Number(data[1]));
                    }
                    getShoppingCart();
                    $("#itemCountInCart").html(data[0]);
                }
                else {
                    Swal.fire("輸入商品數量有誤");
                    return false;
                }
            }
        });
        $(".purchaseStyle").click(async function () {
            let price = $(this).siblings(".price").html();
            $(".itemPrice").html(`$${price}`);
            $(this).removeClass("btn-outline-secondary").removeClass("btn-danger").addClass("btn-danger").closest("div").siblings().children("label").removeClass("btn-outline-secondary").removeClass("btn-danger").addClass("btn-outline-secondary");
            const productDetailID = $(this).siblings("input").val();
            const requestUrl = "@Url.Content("~/Delivery/ShowQtyToSpecificMember")" + `?productDetailID=${productDetailID}`;
            const response = await fetch(requestUrl);
            const data = await response.text();
            $(".itemRemainingQty").html(data);
            if (Number(data) <= 0) {
                $("input[name='purchaseCount']").attr("min", 0);
                $("input[name='purchaseCount']").attr("max", 0);
                $("input[name='purchaseCount']").val(0);
                $("input[name='purchaseCount']").prop("disabled", true);
                $(".addToCart").prop("disabled", true);
                $(".buyDirectly").prop("disabled", true);
                $(this).prop("disabled", true);
            }
            else {
                $("input[name='purchaseCount']").attr("min", 1);
                $("input[name='purchaseCount']").attr("max", Number(data));
                $("input[name='purchaseCount']").val(1);
                $("input[name='purchaseCount']").prop("disabled", false);
                $(".addToCart").prop("disabled", false);
                $(".buyDirectly").prop("disabled", false);
                $(this).prop("disabled", false);
                userIsSeller();
            }

        });

        //檢舉功能圖片預覽
        $('#ReportPic').on('change', function (e) {
            const file = this.files[0];
            const objectURL = URL.createObjectURL(file);    // 使用 createObjectURL 產生圖片url
            $('#Preview').attr('src', objectURL);
        });
        //檢舉功能圖片預覽

        //檢舉功能
        let ProductId = document.getElementById("ProductId");
        let ReporterID = document.getElementById("ReporterID");
        let ReportTypeID = document.getElementById("ReportTypeId");
        let Reason = document.getElementById("Reason");
        let Report;
        let ReportPic;
        let Save = document.getElementById("save");

        $("#ReportPic").change(function () {
            const photos = document.getElementById("ReportPic").files;
            if (photos) {
                $.each(photos, function (idx, photo) {
                    let reader = new FileReader();
                    reader.readAsDataURL(photo);
                    reader.onloadend = function () {
                        ReportPic = reader.result;
                    }
                });
            }
        });


        Save.addEventListener("click", () => {
            if (!Reason.value || ReportPic == null) {
                Swal.fire("所有欄位皆是必填!");
            }
            else {
                Report = {
                    ProductId: ProductId.value,
                    ReporterID: ReporterID.value,
                    ReportTypeID: ReportTypeID.options[ReportTypeID.selectedIndex].value,
                    Reason: Reason.value,
                    ReportPic: ReportPic.split(',')[1]
                }
                jQuery.postJSON = function (url, data, callback) {
                    jQuery.post(url, data, callback, "json");
                };
                console.log(Report);
                $.postJSON("/Item/ReportCreate", { d: Report }, function () { });
                Swal.fire("檢舉成功");
                $("#reportmodal").modal('hide');
            }
        })


        $(".talkToSeller").click(function () {
            const sellerAcc = $(".sellerName").attr("id");
            happy_popup(sellerAcc);
        });

        $(".messageBoardVC").on("click", ".messageSubmit", async function () {
            const message = $(this).siblings(".message").val();
            if (message == "") {
                Swal.fire("請輸入留言內容");
            }
            else {
                const messageType = $(this).siblings(".message").attr("placeholder");
                const productID = Number($(this).closest(".messageLayout").find(".productID").html());
                let messageParentID = 0;
                if (messageType == "回覆......") {
                    messageParentID = Number($(this).closest(".messageBoardID").attr("id").substring(14));
                }
                const response = await fetch("@Url.Content("~/Item/AddMessage")" + `?messageParentID=${messageParentID}&message=${message}&productID=${productID}`);
                const data = await response.text();
                if (data == "1") {
                    $(".messageBoardVC").load("@Url.Content("~/Item/ShowMessageBoard")" + `?productID=${productID}`);
                }
                else {
                    Swal.fire("請先登入再留言");
                }
            }
        });

        $(".messageBoardVC").on("click", ".messageLikeBtn", async function () {
            const messageParentID = Number($(this).closest(".messageBoardID").attr("id").substring(14));
            const productID = Number($(this).closest(".messageLayout").find(".productID").html());
            const response = await fetch("@Url.Content("~/Item/LikeMessageBoard")" + `?messageBoardID=${messageParentID}`);
            const data = await response.text();
            if (data == "1") {
                $(".messageBoardVC").load("@Url.Content("~/Item/ShowMessageBoard")" + `?productID=${productID}`);
            }
            else {
                Swal.fire("請先登入再按讚");
            }
        });

        $(".messageBoardVC").on("click", ".deleteReplyBtn", function () {
            Swal.fire({
                title: "確定要收回留言嗎?",
                showDenyButton: true,
                showCancelButton: false,
                confirmButtonText: "確定",
                denyButtonText: "取消",
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const messageParentID = Number($(this).closest(".messageBoardID").attr("id").substring(14));
                    const productID = Number($(this).closest(".messageLayout").find(".productID").html());
                    const response = await fetch("@Url.Content("~/Item/DeleteMessage")" + `?messageBoardID=${messageParentID}`);
                    const data = await response.text();
                    if (data == "1") {
                        $(".messageBoardVC").load("@Url.Content("~/Item/ShowMessageBoard")" + `?productID=${productID}`);
                    }
                } else if (result.isDenied) {

                }
            });
        });
       
        $(".messageBoardVC").on("click", ".collapseMessage", function () {
            const thisLayerNumber = Number($(this).closest(".messageBoardID").attr("class").split(' ')[0].substring(5));
            if ($(this).closest(".messageBoardID").nextAll(".messageBoardID").length > 0) {
                if ($(this).html() == "收合") {
                    $(this).closest(".messageBoardID").nextAll(".messageBoardID").each(function (event) {
                        const layerNumber = Number($(this).attr("class").split(' ')[0].substring(5));
                        if (layerNumber > thisLayerNumber) {
                            console.log($(this).attr("class"));
                            $(this).removeClass("d-none").addClass("d-none");
                            console.log($(this).attr("class"));
                        }
                        else {
                            return;
                        }
                    })
                    $(this).html("展開");
                }
                else {
                    $(this).closest(".messageBoardID").nextAll(".messageBoardID").each(function () {
                        const layerNumber = Number($(this).attr("class").split(' ')[0].substring(5));
                        if (layerNumber > thisLayerNumber) {
                            console.log($(this).attr("class"));
                            $(this).removeClass("d-none");
                            console.log($(this).attr("class"));
                            if ($(this).has(".collapseMessage").length > 0) {
                                $(this).find(".collapseMessage").html("收合");
                            }
                        }
                        else {
                            return;
                        }
                    })
                    $(this).html("收合");
                }
            }
        })

        $(".messageBoardVC").on("click", ".messageReplyBtn", function () {
            $(this).closest(".messageFooter").siblings(".messageReplay").slideToggle();
        });

    </script>
}
