@model prjiSpanFinal.ViewModels.Item.CItemIndexViewModel
@{
    ViewData["Title"] = "Index";
}
@section Styles{
    <link rel="stylesheet" href="~/css/Item/ItemIndex.css" />
    <link href="~/css/ProductCard.css" rel="stylesheet" />
}



<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Content("~/Home/Index")">蝦到爆</a></li>
        <li class="breadcrumb-item"><a href="#">@Model.bigType</a></li>
        <li class="breadcrumb-item active" aria-current="page">@Model.smallType</li>
    </ol>
</nav>
<div class="d-flex justify-content-between">
    <div class="productPhoto">
        <div class="bigPhoto position-relative">
            <div class="addItemLike">加入按讚好物</div>
            <i class="itemHeart fa-solid fa-heart position-absolute top-0 end-0 fs-2 opacity-50"></i>
            @{
                string imgSrc1 = "";
                try
                {
                    string base64 = Convert.ToBase64String(Model.productPics[0]);
                    imgSrc1 = $"data:image/gif;base64,{base64}";
                }
                catch
                {
                    imgSrc1 = Url.Content("~/img/imageNotFound.png");
                }
                <img src="@imgSrc1" />
            }
        </div>
        <div class="smallPhoto d-flex justify-content-center">
            @foreach (var i in Model.productPics)
            {
                string imgSrc2 = "";
                try
                {
                    string base65 = Convert.ToBase64String(i);
                    imgSrc2 = $"data:image/gif;base64,{base65}";
                }
                catch
                {
                    imgSrc2 = Url.Content("~/img/imageNotFound.png");
                }
                <div><img src="@imgSrc2" /></div>
            }
        </div>
        <div style="font-size:14px">
            <div class="d-flex justify-content-between border-top border-bottom py-2">
                <div>商品編號:<span class="ms-2">@Model.product.ProductId</span></div>
                <a href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#reportmodal">檢舉</a>
            </div>
            <div>
                <div class="fs-6 fw-b">商品備註</div>
                <ul>
                    <li>物品狀況:全新</li>
                    <li>物品所在地:台灣，台北市</li>
                    <li>最新關注時間:2022-10-07</li>
                    <li>上架時間:2020-03-09</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="itemInfo">
        <h4>@Model.product.ProductName</h4>
        <div class="d-flex justify-content-start align-items-center">
            @{
                int starCount = 4;
                for (int i = 1; i <= 5; i++)
                {
                    if (i <= starCount)
                    {
                        <div class="starBox"><img src="~/img/YellowStar.png" /></div>
                    }
                    else
                    {
                        <div class="starBox"><img src="~/img/WhiteStar.png" /></div>
                    }
                }
                <div class="ms-3">
                    4.2
                </div>
                <div class="ms-1">
                    <span>(</span><a href="#">10</a><span>)</span>
                </div>
                <div class="ms-3">|</div>
                <div class="ms-3">已售出: 15</div>
            }
        </div>
        <div class="itemDetails">
            <form method="post" action="/Delivery/Checkout">
                <div class="d-flex justify-content-start align-items-center mb-1">
                    <div class="itemKey">直購價:</div>
                    @{
                        string price = "";
                        List<decimal> prices = new List<decimal>();
                        foreach (var p in Model.productDetails)
                        {
                            prices.Add(p.UnitPrice);
                        }
                        decimal maxPrice = prices.Max();
                        decimal minPrice = prices.Min();
                        if (minPrice == maxPrice)
                        {
                            price = "$" + minPrice.ToString("0");
                        }
                        else
                        {
                            price = $"${minPrice.ToString("0")} - ${maxPrice.ToString("0")}";
                        }
                        <div class="itemPrice ms-3 fs-3 fw-bold text-danger">@price</div>
                    }
                </div>
                <div class="d-flex justify-content-between align-self-start mb-1">
                    <input type="hidden" name="purchaseProduct" value="2113" />
                    <div class="itemKey">規格:</div>
                    <div class="itemStyleContent d-flex flex-wrap ms-3">
                        @{
                            foreach (var i in Model.productDetails)
                            {
                                string imgSrc = "";
                                try
                                {
                                    string base65 = Convert.ToBase64String(i.Pic);
                                    imgSrc = $"data:imgae/gif;base64,{base65}";
                                }
                                catch
                                {
                                    imgSrc = Url.Content("~/img/imageNotFound.png");
                                }
                                string style = i.Style;
                                int productDetailID = i.ProductDetailId;
                                string labelId = "style" + productDetailID;
                                string unitPrice = i.UnitPrice.ToString("0");
                                int quantity = i.Quantity;
                                <div class="ms-1 mb-1">
                                    <input type="radio" class="btn-check" name="purchaseStyle" id="@labelId" autocomplete="off" value="@productDetailID">
                                    <label class="purchaseStyle btn btn-outline-secondary btn-sm rounded-1" for="@labelId">@style</label>
                                    <div class="d-none price">@unitPrice</div>
                                    <img class="d-none itemStyleImg" src="@imgSrc" />
                                </div>
                            }
                        }
                    </div>
                </div>
                <div class="d-flex justify-content-start align-items-center mb-3">
                    <label for="itemCount" class="itemKey">數量:</label>
                    <input type="number" value="1" name="purchaseCount" min="1" class="ms-3" id="itemCount" />
                    <div class="itemRemainingQty ms-3">還剩件數</div>
                </div>
                <div class="position-relative d-flex justify-content-start align-items-center ps-5">
                    <div class="dollarIcon position-absolute fs-3 fw-bold text-warning">+<span></span></div>
                    <input type="button" value="加入購物車" class="addToCart btn btn-warning me-3 ms-4" />
                    <input type="submit" value="直接購買" class="buyDirectly btn btn-success" />
                </div>
            </form>
        </div>
        <div class="my-2 py-4 d-flex border-top border-bottom">
            <div class="d-flex me-2" style="font-size:14px">
                <div class="border py-4 px-2">
                    <div class="bg-danger text-white rounded-5 w-50 px-1 my-1 text-center">限時限量</div>
                    <div class="fs-6 fw-bold my-1">滿$799<span class="ms-2">現折$50</span></div>
                    <div class="my-1">
                        <div>限時優惠滿799折50<span>限量輸碼PO50</span></div>
                        <div>2022/08/30<span class="ms-1">18:00</span>-2022/11/29<span class="ms-1">00:00</span></div>
                    </div>
                </div>
                <button class="btn btn-warning rounded-0 fw-bold">領取</button>
            </div>
            <div class="d-flex" style="font-size:14px">
                <div class="couponDiv">
                    <img src="~/img/Event/Coupon_Jacob.png"/>
                </div>
                <div class="border py-4 px-2">
                    <div class="bg-danger text-white rounded-5 w-50 px-1 my-1 text-center">限時限量</div>
                    <div class="fs-6 fw-bold my-1">滿$799<span class="ms-2">現折$50</span></div>
                    <div class="my-1">
                        <div>限時優惠滿799折50<span>限量輸碼PO50</span></div>
                        <div>2022/08/30<span class="ms-1">18:00</span>-2022/11/29<span class="ms-1">00:00</span></div>
                    </div>
                </div>
                @*<button class="btn btn-warning rounded-0 fw-bold">領取</button>*@
            </div>
        </div>
        <div class="row">
            <div class="col-8" style="font-size:14px">
                <div class="d-flex justify-content-start">
                    <div class="me-5">付款方式:</div>
                    <div>
                        <div>PChomePay支付連 現金 (ATM、餘額、銀行支付)</div>
                        <div>7-11取貨付款</div>
                        <div>全家取貨付款</div>
                        <div>萊爾富取貨付款</div>
                    </div>
                </div>
                <div class="d-flex justify-content-start">
                    <div class="me-5">運送方式:</div>
                    <div>
                        <div>7-11取貨付款<span class="fw-bold">60元</span></div>
                        <div>7-11取貨<span class="fw-bold">79元</span></div>
                        <div>全家取貨付款<span class="fw-bold">60元</span></div>
                        <div>全家取貨<span class="fw-bold">60元</span></div>
                        <div>萊爾富取貨付款<span class="fw-bold">45元</span></div>
                        <div>萊爾富取貨<span class="fw-bold">45元</span></div>
                        <div>宅配/快遞<span class="fw-bold">79元</span></div>
                    </div>
                </div>
            </div>
            <div class="col-4" style="font-size:14px">
                <div class="bg-secondary text-white fw-bold ps-2">買家資訊</div>
                <div class="ps-2">林小偉<span class="ms-3"><a href="#"><i class="fa-solid fa-comment-dots text-warning"></i></a></span></div>
                <div class="d-flex align-items-center ps-2">
                    <div>全部商品:</div>
                    <div class="ms-3"><a href="@Url.Content("~/SalesCourt/賣場")" class="fs-5 fw-bold text-primary ">311</a></div>
                </div>
                <div class="d-flex align-items-center ps-2">
                    <div>賣場評價:</div>
                    <div class="ms-3"><a href="@Url.Content("~/SalesCourt/評價")" class="fs-5 fw-bold text-primary ">4.9 (766)</a></div>
                </div>

                <div class="ps-2"><a href="@Url.Content("~/SalesCourt/關於我")" class="text-primary">關於我</a></div>
                <div class="ps-2"><a href="@Url.Content("~/SalesCourt/賣場")" class="text-primary">追蹤賣家</a></div>
            </div>
        </div>


    </div>
</div>
<div class="sellerProducts mt-3">
    <div class="d-flex justify-content-between align-items-center mb-1">
        <div class="fs-3 fw-bold text-primary">賣家精選</div>
        <div class="pageSelect d-flex align-items-center">
            @{
                int totalPage = 20;
            }
            <div class="fs-4 id=" sellerProductPage""><span id="page">1</span>/<span id="totalPage">@totalPage</span></div>
            <button id="previousPage" disabled><</button>
            <button id="nextPage">></button>
        </div>
    </div>

    <div class="sellerProductsLayout">
        <div class="">
            @{
                foreach (var product in Model.sellerProducts)
                {
                    @await Component.InvokeAsync("ProductCard", new { sellerProduct = product });
                }
            }
        </div>
    </div>
</div>



<div class="productDescription">
    <div class="list-group list-group-horizontal mb-3">
        <button type="button" class="list-group-item list-group-item-action active" id="description" aria-current="true">商品說明</button>

        <button type="button" class="list-group-item list-group-item-action" id="comment">商品評價 (4.0/5)</button>
        <button type="button" class="list-group-item list-group-item-action" id="buyerCount">購買人次 (55)</button>
    </div>
    <div class="partialView">

    </div>

</div>

<!--Modal-->
<div class="modal fade" id="reportmodal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="top: 7rem !important;">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">檢舉視窗</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div>
                    <label>產品名稱</label>
                    <input class="form-control" placeholder="【JUST台灣現貨】獨家顏色！台灣製造30000mAh PD/QC快充3A 行動電源 保固一年 行動電源 行動充 隨身充" readonly>

                    <label>檢舉理由</label>
                    <select class="form-select">
                        <option value="廣告不實">廣告不實</option>
                        <option value="商品圖片違反善良風俗">商品圖片違反善良風俗</option>
                        <option value="違法商品">違法商品</option>
                        <option value="這個賣家太糟糕了">這個賣家太糟糕了</option>
                        <option value="內容和實際商品不符">內容和實際商品不符</option>
                    </select>
                    <label>詳細檢舉理由</label>
                    <textarea class="form-control"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save" type="button" class="btn btn-warning">新增</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

<!--Modal End-->


@section Scripts{
    <script src="~/js/Item/ItemIndex.js"></script>
    <script>
        $(".bigPhoto .itemHeart").click(async function () {
            let requestUrl = "@Url.Content("~/Item/AddItemLike")" + `?memberID=57&productID=${@Model.product.ProductId}`;
            let response = await fetch(requestUrl);
            let data = await response.text();
            if (data == 1) {
                $(this).addClass("text-danger");
            }
            else {
                $(this).removeClass("text-danger");
            }
            console.log(data);
        })

        $(".addToCart").click(async function () {
            if ($("input[name='purchaseStyle']:checked").length != 1) {
                alert("請選擇一個規格");
                return false;
            }
            else {
                const productDetailID = $("input:checked").val();
                const quantity = $("#itemCount").val();
                const requestUrl = "@Url.Content("~/Delivery/AddItemToCart")" + `?productDetailID=${productDetailID}&quantity=${quantity}`;
                const response = await fetch(requestUrl);
                const data = await response.json();

                $(".dollarIcon").children().html(quantity);
                $(".dollarIcon").animate({
                    top: "-=50",
                    opacity: "1",
                    zIndex: "0"
                }, 50).animate({
                    top: "-=30",
                    opacity: "0",
                }, 500).animate({
                    top: "+=80",
                    zIndex:"-1"
                });
                $(".itemRemainingQty").html("還剩" + data[1] + "件");
                $("input[name='purchaseCount']").attr("max", Number(data[1]))
                if ($("input[name='purchaseCount']").val() > Number(data[1])) {
                    $("input[name='purchaseCount']").val(Number(data[1]));
                }
                if (Number(data[1]) <= 0) {
                    $("input:checked").attr("disabled", true);
                    $("input[name='purchaseCount']").val(Number(data[1]));
                }
                $("#itemCountInCart").html(data[0]);
            }
        });
        $(".purchaseStyle").click(async function () {
            let price = $(this).siblings(".price").html();
            $(".itemPrice").html(price);
            $(this).removeClass("btn-outline-secondary").removeClass("btn-danger").addClass("btn-danger").closest("div").siblings().children("label").removeClass("btn-outline-secondary").removeClass("btn-danger").addClass("btn-outline-secondary");
            const productDetailID = $(this).siblings("input").val();
            const requestUrl = "@Url.Content("~/Delivery/ShowQtyToSpecificMember")" + `?productDetailID=${productDetailID}`;
            const response = await fetch(requestUrl);
            const data = await response.text();
            $(".itemRemainingQty").html("還剩" + data + "件");
            $("input[name='purchaseCount']").attr("max", Number(data))
        });
        




        $(function () {
            $(".partialView").load('@Url.Action("Description")');
        });
        $("#description").click(function () {
            $(this).attr("aria-current", true).removeClass("active").addClass("active").siblings().attr("aria-current", false).removeClass("active");
            $(".partialView").load('@Url.Action("Description")');
        });
        $("#comment").click(function () {
            $(this).attr("aria-current", true).removeClass("active").addClass("active").siblings().attr("aria-current", false).removeClass("active");
            $(".partialView").load('@Url.Action("Comment", new { id=1 })');
        });
        $("#buyerCount").click(function () {
            $(this).attr("aria-current", true).removeClass("active").addClass("active").siblings().attr("aria-current", false).removeClass("active");
            $(".partialView").load('@Url.Action("BuyerCount", new { id=1 })');
        });
    </script>
}
