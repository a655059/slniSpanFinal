@model prjiSpanFinal.ViewModels.Item.CBiddingItemUploadViewModel
@{
    ViewData["Title"] = "BiddingItemUpload";
}

<style>
    .previewItemPhoto > div {
        width: 100px;
        height: 100px;
        position: relative;
        margin-right: 10px;
    }

    .previewItemPhoto i {
        position: absolute;
        right: -5px;
        top: -5px;
        opacity: 0;
        color: red;
    }

    .previewItemPhoto > div > img {
        width: 100%;
        aspect-ratio: 1/1;
        object-fit: contain;
    }
</style>

<h1>上架競標商品</h1>
<div class="w-50 m-auto">
    <h3>商品資訊</h3>

    <form action="@Url.Content("~/Item/BiddingItemSave")" method="post" name="biddingItem" enctype="multipart/form-data">
        <div class="input-group mb-3">
            <span class="input-group-text" id="basic-addon1">商品名稱</span>
            <input type="text" name="itemName" class="form-control" placeholder="商品名稱" aria-label="商品名稱" aria-describedby="basic-addon1" required>
        </div>
        <div class="mb-3 d-flex justify-content-between">
            <label class="fs-5">類別</label>
            <select name="bigType" class="bigType fs-5 rounded-2 border" style="width:40%">
                @{
                    foreach (var i in Model.bigTypes)
                    {
                        <option value="@i.BigTypeId">@i.BigTypeName</option>
                    }
                }
            </select>
            <select name="smallType" class="smallType fs-5 rounded-2 border" style="width:40%">
                @{
                    foreach (var i in Model.smallTypes)
                    {
                        <option value="@i.SmallTypeId">@i.SmallTypeName</option>
                    }
                }
            </select>
        </div>
        <div class="input-group mb-3">
            <span class="input-group-text" id="basic-addon1">起標價格$NT</span>
            <input type="text" name="startPrice" class="form-control" placeholder="起標價格" aria-label="起標價格" aria-describedby="basic-addon1" required>
        </div>
        <div class="mb-3 d-flex justify-content-between">
            <label class="fs-5">開始時間</label>
            <input type="date" name="startDate" class="startDate fs-5 rounded-2 border" style="width:40%" required/>
            <input type="time" name="startTime" class="startTime fs-5 rounded-2 border" style="width:40%" required/>
        </div>
        <div class="mb-3 d-flex justify-content-between">
            <label class="fs-5">結束時間</label>
            <input type="date" name="endDate" class="endDate fs-5 rounded-2 border" style="width:40%" required/>
            <input type="time" name="endTime" class="endTime fs-5 rounded-2 border" style="width:40%" required/>
        </div>
        <div class="input-group mb-3">
            <span class="input-group-text" id="basic-addon1">商品數量</span>
            <input type="text" name="count" value="1" disabled class="form-control" placeholder="商品數量" aria-label="商品數量" aria-describedby="basic-addon1" required>
            <span class="input-group-text" id="basic-addon1">件</span>
        </div>
        <div class="input-group">
            <span class="input-group-text">商品描述</span>
            <textarea name="description" class="form-control" aria-label="商品描述" placeholder="商品描述" required></textarea>
        </div>
        <div class="my-3">
            <div class="previewItemPhoto d-flex">
                @*Preview Photo*@
            </div>
            <label class="addPhoto btn btn-outline-warning btn-sm" for="itemPhoto">
                <i class="fa-solid fa-camera-retro me-2">新增照片</i>
            </label>
            <input type="file" name="itemPhotos" value="" id="itemPhoto" class="itemPhoto" style="opacity:0" accept="image/*" multiple required/>

        </div>
        <div class="d-flex justify-content-center">
            <button type="button" class="clearAll btn btn-outline-danger mx-2">清除</button>
            <button class="submit btn btn-warning ms-2">送出</button>
        </div>
    </form>
</div>

@section Scripts{
    <script>
        $(function () {
            const today = GetToday();
            $(".startDate").attr("min", today);
            $(".startDate").val(today);
        });

        function GetToday() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            let date = today.getDate();
            if (date < 10) {
                date = "0" + date;
            }
            return `${year}-${month}-${date}`;
        };

        $(".submit").click(async function (event) {
            event.preventDefault();
            let formData = new FormData(document.biddingItem)
            const response = await fetch(document.biddingItem.action, {
                method: "POST",
                body: formData,
            });
            const data = await response.text();
            if (data == "1") {
                Swal.fire("商品儲存成功");
            }
            else {
                Swal.fire("起標價格式為整數，請檢查是否錯誤");
            }
        });


        $(".clearAll").click(function () {
            $("input").not("input[name='count']").val("");
            $("input[name='startDate']").val(GetToday());
            $(".previewItemPhoto").empty();
            $("textarea").val("");
        });

        $(".itemPhoto").change(function () {
            const photos = $(this)[0].files;
            $(".previewItemPhoto").empty();
            if (photos) {
                $.each(photos, function (idx, photo) {
                    let src = URL.createObjectURL(photo);
                    let idName = "photo" + idx;
                    $(".previewItemPhoto").append(`<div class="deleteItemPhoto" id="${idName}"><i class="fa-solid fa-circle-xmark"></i><img src="${src}" /></div>`);
                });
            }
        });

        $(".bigType").change(async function () {
            const bigTypeID = $(this).find(":selected").val();
            const response = await fetch("@Url.Content("~/Item/GetSmallType")" + `?bigTypeID=${bigTypeID}`);
            const data = await response.json();
            if (data != null) {
                console.log(data);
                $(".smallType").empty();
                let str = "";
                data.forEach(function (value, idx) {
                    str += `<option value="${value.smallTypeId}">${value.smallTypeName}</option>`;
                });
                $(".smallType").html(str);
            }
        })
    </script>
}