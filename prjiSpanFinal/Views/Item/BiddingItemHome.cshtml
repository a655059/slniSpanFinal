@model List<int>
@{
    ViewData["Title"] = "BiddingItemHome";
}

<h1>蝦到爆競標</h1>
<div class="biddingLayout">
    <div class="newArival">
        @*@await Component.InvokeAsync("ShowSelectedBiddingItems", new { biddingIDs = Model })*@
    </div>
</div>



@section Scripts{
    @*<script src="@Url.Content("~/js/Item/ShowItemCountdown.js")"></script>*@
    <script src="@Url.Content("~/js/ShowSelectedBiddingItems.js")"></script>
    @*<script src="~/js/Item/Countdown.js"></script>*@
<script>
    $($(".newArival").load("@Url.Action("ShowSelectedBiddingItems", "Item")"));

    
    let connection3 = new signalR.HubConnectionBuilder().withUrl("/selectedBiddingItemsCountdownHub").build();


    let biddingIDs = [];
    connection3.on("ShowItemCountdown", function (remainingTimes, ids) {
        $(".biddingItemLayout").each(function (index, element) {
            let biddingID = Number($(this).attr("id"));
            for (let i = 0; i < ids.length; i++) {
                if (ids[i] == biddingID) {
                    $(this).find(".remainingTime").html(remainingTimes[i]);
                }
            }
        });
    });

    connection3.on("ShowUploadItem", function () {
        $(".newArival").load("@Url.Action("ShowSelectedBiddingItems", "Item")");
        biddingIDs = [];
        $(".biddingItemLayout").each(function () {
            biddingIDs.push(Number($(this).attr("id")));
        });
        connection3.invoke("SelectedBiddingItemsCountdown", biddingIDs)
    });
    
    connection3.start().then(function () {
        console.log("connect3 start");
        biddingIDs = [];
        $(".biddingItemLayout").each(function () {
            biddingIDs.push(Number($(this).attr("id")));
        });
        connection3.invoke("SelectedBiddingItemsCountdown", biddingIDs)
    }).catch(function (err) {
        console.log(err);
    });




    function ControlPage() {
        $(".page").each(function () {
            let currentPage = Number($(this).html());
            let totalPage = Number($(this).siblings(".totalPage").html());
            if (currentPage == 1) {
                $(this).closest("div").siblings(".previousPage").attr("disabled", true).css("background-color", "#FFDCB9").css("color", "#D0D0D0");
            }
            else {
                $(this).closest("div").siblings(".previousPage").attr("disabled", false).css("background-color", "#FFA042").css("color", "black");
            }
            if (currentPage == totalPage) {
                $(this).closest("div").siblings(".nextPage").attr("disabled", true).css("background-color", "#FFDCB9").css("color", "#D0D0D0");
            }
            else {
                $(this).closest("div").siblings(".nextPage").attr("disabled", false).css("background-color", "#FFA042").css("color", "black");
            }
        });
    }


    $(".biddingLayout").on("click", ".nextPage", function () {
        const page = Number($(this).siblings("div").find(".page").html()) + 1;
        $(this).siblings("div").find(".page").html(page);
        $(this).closest("div").siblings(".VCLayout").find(".biddingItemLayout").animate({ left: "-=1050px" });
        ControlPage();
    });


    $(".biddingLayout").on("click", ".previousPage", function () {
        const page = Number($(this).siblings("div").find(".page").html()) - 1;
        $(this).siblings("div").find(".page").html(page);
        $(this).closest("div").siblings(".VCLayout").find(".biddingItemLayout").animate({ left: "+=1050px" });
        ControlPage();
    });



   /* let connection2 = new signalR.HubConnectionBuilder().withUrl("/countdownHub").build();*/

    @*connection3.on("ShowUploadItem", function () {
        $(".newArival").load("@Url.Action("ShowSelectedBiddingItems", "Item", new { biddingIDs = Model})");
        biddingIDs = [];
        $(".biddingItemLayout").each(function () {
            biddingIDs.push(Number($(this).attr("id")));
        });
        console.log(biddingIDs);
        connection3.invoke("SelectedBiddingItemsCountdown", biddingIDs)
    });*@

    //connection2.start().then(function () {
    //    console.log("connect2 start");
    //    //connection2.invoke("Countdown");
    //}).catch(function (err) {
    //    console.log(err);
    //});
</script>
}
